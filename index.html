<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Preg√µes P√∫blicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --card: #0b1120;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #2563eb;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617 45%);
      color: var(--text);
    }
    header {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: #020617dd;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { font-size: 18px; margin: 0; }
    header p  { margin: 4px 0 0; font-size: 13px; color: var(--muted); }

    .container {
      max-width: 1100px;
      margin: 12px auto 40px;
      padding: 0 12px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    }

    .filters {
      display: grid;
      grid-template-columns: 1.6fr 0.7fr 0.7fr;
      gap: 8px;
    }
    label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }
    input, button {
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 14px;
      width: 100%;
    }
    input::placeholder { color: #6b7280; }

    button {
      background: var(--primary);
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    button:hover {
      opacity: 0.95;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
      transform: translateY(-1px);
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      min-height: 16px;
    }
    .status.ok  { color: #4ade80; }
    .status.err { color: #f97373; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th {
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }
    td:nth-child(1) { width: 20%; }
    td:nth-child(2) { width: 50%; }
    td:nth-child(3) { width: 15%; }
    td:nth-child(4) { width: 15%; text-align: right; }

    .valor {
      color: var(--success);
      font-weight: 600;
      white-space: nowrap;
    }
    .summary {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .summary strong,
    .summary .valor { color: var(--text); }

    footer {
      text-align: center;
      padding: 16px;
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      header h1 { font-size: 16px; }
      .filters { grid-template-columns: 1fr; }

      table, thead { display: block; }
      thead { display: none; }
      tbody { display: block; }

      tr {
        display: block;
        margin-bottom: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        background: #020617;
      }
      td {
        display: block;
        border-bottom: none;
        padding: 4px 0;
      }
      td:nth-child(1) { font-weight: 600; color: #e5e7eb; }
      td:nth-child(3) { font-size: 12px; color: var(--muted); }
      td:nth-child(4) { text-align: left; margin-top: 4px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>üîç Buscador de Preg√µes P√∫blicos</h1>
    <p>Consulta r√°pida no PNCP para ter base de valores em or√ßamentos</p>
  </header>

  <div class="container">
    <div class="card">
      <div class="filters">
        <div>
          <label for="q">Descri√ß√£o / objeto</label>
          <input id="q" placeholder="Ex: pintura, manuten√ß√£o, telhado, el√©trica" />
        </div>
        <div>
          <label for="ano">Ano</label>
          <input id="ano" type="number" value="2024" />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button onclick="buscar()">Buscar preg√µes</button>
        </div>
      </div>
      <div id="status" class="status"></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>√ìrg√£o</th>
            <th>Objeto</th>
            <th>Modalidade</th>
            <th>Valor estimado</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>

      <div id="resumo" class="summary"></div>
    </div>
  </div>

  <footer>
    Dados oficiais via PNCP ‚Ä¢ proxy: Cloudflare Workers ‚Ä¢ uso apenas como refer√™ncia de or√ßamento
  </footer>

  <script>
    async function buscar() {
      const termo  = document.getElementById("q").value.toLowerCase().trim();
      const ano    = document.getElementById("ano").value;
      const status = document.getElementById("status");
      const lista  = document.getElementById("lista");
      const resumo = document.getElementById("resumo");

      status.textContent = "Buscando dados no PNCP...";
      status.className   = "status";
      lista.innerHTML    = "";
      resumo.innerHTML   = "";

      try {
        const proxy = "https://pncp-proxy.jhonygui.workers.dev";

        // Datas do ano selecionado (formato exigido: AAAAMMDD)
        const dataInicial = `${ano}0101`;
        const dataFinal   = `${ano}1231`;

        // Endpoint p√∫blico oficial de consultas do PNCP (contrata√ß√µes por data de publica√ß√£o)
        // https://pncp.gov.br/api/consulta/v1/contratacoes/publicacao
        const alvo =
          `https://pncp.gov.br/api/consulta/v1/contratacoes/publicacao` +
          `?dataInicial=${dataInicial}` +
          `&dataFinal=${dataFinal}` +
          `&pagina=1&tamanhoPagina=40`;

        const url = `${proxy}?url=${encodeURIComponent(alvo)}`;

        const resp = await fetch(url);

        // 204 = sem conte√∫do (nenhum resultado)
        if (resp.status === 204) {
          status.textContent = "Nenhum resultado encontrado para o per√≠odo informado.";
          return;
        }

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const json = await resp.json();

        // A estrutura padr√£o dessa API tem campo "data" com os registros
        const itens = json.data || json || [];

        let total = 0;
        let count = 0;

        itens.forEach(item => {
          // Alguns campos variam um pouco, protegemos com fallback
          const objeto = (item.objeto || item.objetoContratacao || "").toLowerCase();
          if (termo && !objeto.includes(termo)) return;

          const valor = item.valorEstimado || item.valorTotalEstimado || 0;
          if (valor > 0) {
            total += valor;
            count++;
          }

          const orgao = item.orgaoEntidade?.razaoSocial || item.nomeRazaoSocial || "√ìrg√£o n√£o informado";
          const modalidade = item.modalidadeNome || item.modalidadeContratacao || "-";

          lista.innerHTML += `
            <tr>
              <td>${orgao}</td>
              <td>${item.objeto || item.objetoContratacao || "-"}</td>
              <td>${modalidade}</td>
              <td class="valor">R$ ${valor.toLocaleString("pt-BR")}</td>
            </tr>
          `;
        });

        if (!count) {
          status.textContent = "Nenhum resultado encontrado com esse filtro.";
          return;
        }

        const media = total / count;
        resumo.innerHTML = `
          üìä <strong>Resumo r√°pido</strong><br>
          Registros analisados: <strong>${count}</strong><br>
          Valor m√©dio estimado: <span class="valor">R$ ${media.toLocaleString("pt-BR")}</span><br>
          Soma total: <span class="valor">R$ ${total.toLocaleString("pt-BR")}</span>
        `;
        status.textContent = "Consulta conclu√≠da com sucesso.";
        status.className = "status ok";
      } catch (e) {
        console.error(e);
        status.textContent =
          "Erro ao consultar a API (proxy). Verifique se o Worker est√° ativo.";
        status.className = "status err";
      }
    }
  </script>
</body>
</html>
