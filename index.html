<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Licita√ß√µes ‚Äì RS (PNCP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --bg-card: #111827;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.15);
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px 40px;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    header h1 {
      font-size: clamp(1.5rem, 2.4vw, 2.1rem);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span {
      font-size: 1.5rem;
    }

    header p {
      margin-top: 6px;
      font-size: 0.93rem;
      color: var(--muted);
    }

    .badge-uf {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.4);
      font-size: 0.78rem;
      margin-top: 8px;
    }

    .badge-uf strong {
      color: var(--primary);
    }

    .card {
      background: linear-gradient(145deg, #020617 0, #020617 40%, #020617 60%, #020617 100%);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 14px;
      backdrop-filter: blur(14px);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .input,
    .select {
      width: 100%;
      padding: 10px 11px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .input::placeholder {
      color: #6b7280;
    }

    .input:focus,
    .select:focus {
      border-color: rgba(59, 130, 246, 0.85);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
      background: rgba(15, 23, 42, 1);
    }

    .select[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-size: 0.92rem;
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #f9fafb;
      box-shadow: 0 14px 24px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 28px rgba(37, 99, 235, 0.45);
      filter: brightness(1.05);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.85);
      filter: brightness(0.97);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.8);
      box-shadow: none;
      font-weight: 500;
      padding-inline: 10px;
    }

    .btn-secondary:hover {
      filter: brightness(1.08);
    }

    .actions-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin: 10px 2px 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      background: var(--primary-soft);
      border: 1px solid rgba(37, 99, 235, 0.6);
      font-size: 0.77rem;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
    }

    .error {
      margin: 4px 2px 0;
      font-size: 0.8rem;
      color: var(--danger);
      min-height: 1em;
    }

    .table-wrapper {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.86rem;
    }

    thead {
      background: rgba(15, 23, 42, 0.95);
    }

    th,
    td {
      padding: 9px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.75);
    }

    th {
      font-weight: 600;
      font-size: 0.78rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.07);
    }

    .col-orgao {
      max-width: 210px;
    }

    .col-objeto {
      max-width: 430px;
    }

    .col-objeto span {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .col-municipio {
      white-space: nowrap;
    }

    .col-datas {
      white-space: nowrap;
    }

    .col-valor {
      white-space: nowrap;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
      font-size: 0.74rem;
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.95);
    }

    .tag-primary {
      border-color: rgba(37, 99, 235, 0.7);
      color: #bfdbfe;
      background: rgba(15, 23, 42, 0.98);
    }

    .empty-row td {
      text-align: center;
      padding: 24px 10px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    footer {
      margin-top: 18px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
    }

    footer a {
      color: #93c5fd;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <h1>
        <span>üìä</span>
        Buscador de Licita√ß√µes Abertas ‚Äì PNCP
      </h1>
      <p>Consulta r√°pida a preg√µes eletr√¥nicos com recebimento de propostas em aberto no PNCP.</p>
      <div class="badge-uf">
        <strong>UF: RS</strong>
        <span>‚Ä¢ apenas licita√ß√µes de √≥rg√£os do Rio Grande do Sul</span>
      </div>
    </header>

    <section class="card">
      <form id="busca-form">
        <div class="filters-grid">
          <div class="field">
            <label for="descricao">Palavra-chave no objeto</label>
            <input
              id="descricao"
              class="input"
              type="text"
              placeholder="Ex: manuten√ß√£o el√©trica, pavimenta√ß√£o, alimenta√ß√£o escolar..."
            />
          </div>

          <div class="field">
            <label for="municipio">Munic√≠pio (texto livre)</label>
            <input
              id="municipio"
              class="input"
              type="text"
              placeholder="Ex: Porto Alegre, Caxias..."
            />
          </div>

          <div class="field">
            <label for="data-final">Recebendo propostas at√©</label>
            <input id="data-final" class="input" type="date" />
          </div>
        </div>

        <div class="actions-bar">
          <div style="display:flex; gap:6px; align-items:center;">
            <button type="submit" id="btn-buscar" class="btn">
              üîç Buscar licita√ß√µes
            </button>
            <button type="button" id="btn-limpar" class="btn-secondary">
              Limpar filtros
            </button>
          </div>
          <div>
            <span id="status-text" class="status-pill" style="display:none;">
              <span class="status-dot"></span>
              <span id="status-label">Buscando no PNCP‚Ä¶</span>
            </span>
          </div>
        </div>
        <div id="erro" class="error"></div>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>√ìrg√£o</th>
            <th>Objeto</th>
            <th>Munic√≠pio</th>
            <th>Datas (abertura / encerramento)</th>
            <th>Valor estimado</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="result-body">
          <tr class="empty-row">
            <td colspan="6">
              Preencha os filtros acima e clique em <strong>‚ÄúBuscar licita√ß√µes‚Äù</strong> para ver os resultados.
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      Dados oficiais via PNCP ‚Äì Servi√ßo <code>/v1/contratacoes/proposta</code> ‚Äì Modalidade:
      Preg√£o Eletr√¥nico (c√≥d. 6) :contentReference[oaicite:1]{index=1} ‚Äì
      proxy: Cloudflare Workers. Desenvolvido para apoiar estudos de mercado e or√ßamentos.
    </footer>
  </div>

  <script>
    // üîß Ajuste aqui se o prefixo do Worker for diferente
    const PROXY_BASE = "https://pncp-proxy.jhonygui.workers.dev/pncp-consulta";

    const form = document.getElementById("busca-form");
    const btnBuscar = document.getElementById("btn-buscar");
    const btnLimpar = document.getElementById("btn-limpar");
    const erroEl = document.getElementById("erro");
    const statusPill = document.getElementById("status-text");
    const statusLabel = document.getElementById("status-label");
    const tbody = document.getElementById("result-body");
    const descricaoInput = document.getElementById("descricao");
    const municipioInput = document.getElementById("municipio");
    const dataFinalInput = document.getElementById("data-final");

    // Define data final padr√£o = hoje + 30 dias
    (function initDefaultDate() {
      const today = new Date();
      const d = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      dataFinalInput.value = d.toISOString().slice(0, 10);
    })();

    function formatDateForPNCP(dateStr) {
      if (!dateStr) {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        return `${y}${m}${d}`;
      }
      // dateStr vem em AAAA-MM-DD
      const [y, m, d] = dateStr.split("-");
      return `${y}${m}${d}`;
    }

    function formatDateDisplay(dateTimeStr) {
      if (!dateTimeStr) return "-";
      const date = new Date(dateTimeStr);
      if (isNaN(date.getTime())) return dateTimeStr;
      return date.toLocaleString("pt-BR", {
        timeZone: "America/Sao_Paulo",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function formatCurrencyBRL(value) {
      if (value == null) return "-";
      const num = Number(value);
      if (!isFinite(num) || num === 0) return "-";
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        maximumFractionDigits: 2
      }).format(num);
    }

    function setLoading(loading, label) {
      if (loading) {
        btnBuscar.disabled = true;
        statusPill.style.display = "inline-flex";
        statusLabel.textContent = label || "Buscando no PNCP‚Ä¶";
      } else {
        btnBuscar.disabled = false;
        statusPill.style.display = "none";
      }
    }

    function showError(msg) {
      erroEl.textContent = msg || "";
    }

    function clearTable() {
      tbody.innerHTML = "";
    }

    function showEmpty(msg) {
      clearTable();
      const tr = document.createElement("tr");
      tr.className = "empty-row";
      const td = document.createElement("td");
      td.colSpan = 6;
      td.innerHTML = msg;
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    async function fetchLicitacoesRS({ dataFinal }) {
      const dataFinalPNCP = formatDateForPNCP(dataFinal);

      const all = [];
      let pagina = 1;
      const maxPaginas = 5; // seguran√ßa: evita buscar tudo do Brasil se algo sair errado
      let totalPaginas = 1;

      do {
        const params = new URLSearchParams();
        params.set("dataFinal", dataFinalPNCP);
        params.set("codigoModalidadeContratacao", "6"); // Preg√£o Eletr√¥nico (tabela de dom√≠nio) :contentReference[oaicite:2]{index=2}
        params.set("uf", "RS"); // apenas Rio Grande do Sul
        params.set("pagina", String(pagina));
        params.set("tamanhoPagina", "200");

        const url = `${PROXY_BASE}/v1/contratacoes/proposta?${params.toString()}`;

        const resp = await fetch(url, { headers: { accept: "application/json" } });

        if (resp.status === 204) {
          // Sem conte√∫do
          break;
        }

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(
            `Erro ao consultar proxy/PNCP (HTTP ${resp.status}). Detalhes: ${text}`
          );
        }

        const json = await resp.json();
        const dataArr = json.data || [];
        all.push(...dataArr);

        totalPaginas = json.totalPaginas || 1;
        pagina += 1;
      } while (pagina <= totalPaginas && pagina <= maxPaginas);

      return all;
    }

    function renderResults(lista, { filtroDescricao, filtroMunicipio }) {
      clearTable();

      const desc = (filtroDescricao || "").trim().toLowerCase();
      const mun = (filtroMunicipio || "").trim().toLowerCase();

      const filtrados = lista.filter((item) => {
        const objeto = (item.objetoCompra || "").toLowerCase();
        const municipio =
          (item?.unidadeOrgao?.municipioNome || "").toLowerCase();

        const matchDesc = !desc || objeto.includes(desc);
        const matchMunicipio = !mun || municipio.includes(mun);

        return matchDesc && matchMunicipio;
      });

      if (!filtrados.length) {
        showEmpty(
          "Nenhuma licita√ß√£o encontrada com os filtros atuais. Tente ampliar o per√≠odo ou remover filtros."
        );
        return;
      }

      for (const item of filtrados) {
        const tr = document.createElement("tr");

        // √ìrg√£o
        const orgaoTd = document.createElement("td");
        orgaoTd.className = "col-orgao";
        const orgaoNome = item?.orgaoEntidade?.razaosocial || "-";
        const modalidade = item.modalidadeNome || "Preg√£o Eletr√¥nico";
        orgaoTd.innerHTML = `
          <div>${orgaoNome}</div>
          <div class="tags">
            <span class="tag tag-primary">${modalidade}</span>
            <span class="tag">PNCP: ${item.numeroControlePNCP || "-"}</span>
          </div>
        `;
        tr.appendChild(orgaoTd);

        // Objeto
        const objetoTd = document.createElement("td");
        objetoTd.className = "col-objeto";
        const objeto = item.objetoCompra || "-";
        objetoTd.innerHTML = `<span>${objeto}</span>`;
        tr.appendChild(objetoTd);

        // Munic√≠pio
        const munTd = document.createElement("td");
        munTd.className = "col-municipio";
        const munNome = item?.unidadeOrgao?.municipioNome || "-";
        const ufSigla = item?.unidadeOrgao?.ufSigla || "RS";
        munTd.textContent = munNome ? `${munNome} / ${ufSigla}` : `- / ${ufSigla}`;
        tr.appendChild(munTd);

        // Datas
        const datasTd = document.createElement("td");
        datasTd.className = "col-datas";
        const dtAbertura = formatDateDisplay(item.dataAberturaProposta);
        const dtEnc = formatDateDisplay(item.dataEncerramentoProposta);
        datasTd.innerHTML = `${dtAbertura}<br><span style="color:#9ca3af;">at√© ${dtEnc}</span>`;
        tr.appendChild(datasTd);

        // Valor
        const valorTd = document.createElement("td");
        valorTd.className = "col-valor";
        valorTd.textContent = formatCurrencyBRL(item.valorTotalEstimado);
        tr.appendChild(valorTd);

        // A√ß√µes
        const acaoTd = document.createElement("td");

        const btnVer = document.createElement("button");
        btnVer.type = "button";
        btnVer.className = "btn-secondary";
        btnVer.textContent = "Ver licita√ß√£o";
        btnVer.onclick = () => {
          const idPncp = item.numeroControlePNCP;
          if (!idPncp) {
            alert("Id PNCP n√£o informado para esta contrata√ß√£o.");
            return;
          }
          const urlPncp = `https://pncp.gov.br/app/editais?q=${encodeURIComponent(
            idPncp
          )}`;
          window.open(urlPncp, "_blank");
        };

        acaoTd.appendChild(btnVer);
        tr.appendChild(acaoTd);

        tbody.appendChild(tr);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      showError("");
      setLoading(true, "Buscando licita√ß√µes abertas no PNCP‚Ä¶");
      clearTable();
      showEmpty("Buscando dados no PNCP‚Ä¶");

      const filtros = {
        descricao: descricaoInput.value,
        municipio: municipioInput.value,
        dataFinal: dataFinalInput.value
      };

      try {
        const lista = await fetchLicitacoesRS({ dataFinal: filtros.dataFinal });
        renderResults(lista, {
          filtroDescricao: filtros.descricao,
          filtroMunicipio: filtros.municipio
        });
      } catch (err) {
        console.error(err);
        showEmpty("N√£o foi poss√≠vel carregar as licita√ß√µes.");
        showError(
          "Erro ao consultar a API (proxy/PNCP). Verifique se o Worker est√° ativo e a URL est√° correta."
        );
      } finally {
        setLoading(false);
      }
    });

    btnLimpar.addEventListener("click", () => {
      descricaoInput.value = "";
      municipioInput.value = "";
      initDefaultDate();
      showError("");
      clearTable();
      showEmpty(
        "Filtros limpos. Preencha os campos acima e clique em ‚ÄúBuscar licita√ß√µes‚Äù."
      );
    });
  </script>
</body>
</html>
